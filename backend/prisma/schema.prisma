// Project Management System - Complete Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // URL removed from here - should be in Prisma Client config
}

// Enums
enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatusEnum {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
  BLOCKED
}

enum ProjectStatus {
  NOT_STARTED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum DependencyType {
  FINISH_TO_START
  START_TO_START
  FINISH_TO_FINISH
  START_TO_FINISH
}

enum StorageProvider {
  LOCAL
  S3
  GCS
  AZURE
}

// Base models with relations
model User {
  id        String   @id @default(cuid()) @db.VarChar(255)
  email     String   @unique @db.VarChar(255)
  password  String   @db.VarChar(255)
  firstName String   @db.VarChar(100)
  lastName  String   @db.VarChar(100)
  avatarUrl String?  @db.VarChar(500)
  timezone  String   @default("UTC") @db.VarChar(50)
  isActive  Boolean  @default(true)
  lastLogin DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  
  // Relations
  organizationMembers OrganizationMember[]
  createdProjects Project[] @relation("ProjectCreator")
  updatedProjects Project[] @relation("ProjectUpdater")
  createdTasks    Task[]    @relation("TaskCreator")
  updatedTasks    Task[]    @relation("TaskUpdater")
  assignedTasks   TaskAssignee[]
  comments        Comment[]
  activityLogs    ActivityLog[]
  notifications   Notification[]
  createdFiles    File[] @relation("UserCreatedFiles")
  createdFileVersions FileVersion[] @relation("UserCreatedFileVersions")
  projectTemplates ProjectTemplate[] @relation("UserCreatedProjectTemplates")
  taskStatuses     TaskStatusDefinition[] @relation("UserCreatedTaskStatuses")
  createdRoles     Role[] @relation("UserCreatedRoles")
  mentions        Mention[] @relation("UserMentions")
  mentionedIn     Mention[] @relation("UserMentionedIn")
  
  
  @@map("users")
  @@index([email])
  @@index([isActive])
  @@index([deletedAt])
}

model Organization {
  id        String   @id @default(cuid()) @db.VarChar(255)
  name      String   @db.VarChar(200)
  slug      String   @unique @db.VarChar(100)
  color     String?  @db.VarChar(7)
  logoUrl   String?  @db.VarChar(500)
  settings  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  members OrganizationMember[]
  projects Project[]
  roles Role[]
  projectTemplates ProjectTemplate[]
  taskStatuses TaskStatusDefinition[]
  
  @@map("organizations")
  @@index([slug])
}

model OrganizationMember {
  id             String   @id @default(cuid()) @db.VarChar(255)
  organizationId String   @db.VarChar(255)
  userId         String   @db.VarChar(255)
  roleId         String   @db.VarChar(255)
  joinedAt       DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role         Role         @relation(fields: [roleId], references: [id])
  projectMembers ProjectMember[]
  
  @@unique([organizationId, userId])
  @@map("organization_members")
  @@index([organizationId])
  @@index([userId])
  @@index([roleId])
}

model Role {
  id              String   @id @default(cuid()) @db.VarChar(255)
  name            String   @db.VarChar(100)
  description     String?  @db.Text
  isSystem        Boolean  @default(false)
  organizationId  String   @db.VarChar(255)
  createdById     String   @db.VarChar(255)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  organization    Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members         OrganizationMember[]
  permissions     RolePermission[]
  projectMembers  ProjectMember[]
  createdBy       User?              @relation("UserCreatedRoles", fields: [createdById], references: [id])
  
  @@unique([organizationId, name])
  @@map("roles")
  @@index([organizationId])
  @@index([isSystem])
}

model Permission {
  id          String   @id @default(cuid()) @db.VarChar(255)
  name        String   @unique @db.VarChar(100)
  description String?  @db.Text
  category    String   @db.VarChar(50)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  rolePermissions RolePermission[]
  
  @@map("permissions")
  @@index([category])
}

model RolePermission {
  id            String   @id @default(cuid()) @db.VarChar(255)
  roleId        String   @db.VarChar(255)
  permissionId  String   @db.VarChar(255)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  @@unique([roleId, permissionId])
  @@map("role_permissions")
  @@index([roleId])
  @@index([permissionId])
}

model Project {
  id              String        @id @default(cuid()) @db.VarChar(255)
  name            String        @db.VarChar(200)
  description     String?       @db.Text
  status          ProjectStatus @default(NOT_STARTED)
  priority        Priority      @default(MEDIUM)
  color           String?       @default("#4F46E5") @db.VarChar(7)
  startDate       DateTime?
  dueDate         DateTime?
  completedAt     DateTime?
  organizationId  String        @db.VarChar(255)
  templateId      String?       @db.VarChar(255)
  progress        Int           @default(0) @db.SmallInt
  settings        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  createdById     String        @db.VarChar(255)
  updatedById     String        @db.VarChar(255)
  
  // Relations
  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  template     ProjectTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  createdBy    User             @relation("ProjectCreator", fields: [createdById], references: [id])
  updatedBy    User             @relation("ProjectUpdater", fields: [updatedById], references: [id])
  members      ProjectMember[]
  lists        List[]
  tasks        Task[]
  comments     Comment[]
  activityLogs ActivityLog[]
  notifications Notification[]
  files        File[]
  attachedFiles FileLink[]
  milestones   Milestone[]
  dependencies ProjectDependency[] @relation("SourceProject")
  dependents   ProjectDependency[] @relation("TargetProject")
  
  @@map("projects")
  @@index([organizationId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@index([createdById])
  @@index([templateId])
}

model ProjectDependency {
  id        String         @id @default(cuid()) @db.VarChar(255)
  sourceId  String         @db.VarChar(255)
  targetId  String         @db.VarChar(255)
  type      DependencyType @default(FINISH_TO_START)
  createdAt DateTime       @default(now())
  
  // Relations
  source Project @relation("SourceProject", fields: [sourceId], references: [id], onDelete: Cascade)
  target Project @relation("TargetProject", fields: [targetId], references: [id], onDelete: Cascade)
  
  @@unique([sourceId, targetId])
  @@map("project_dependencies")
  @@index([sourceId])
  @@index([targetId])
}

model ProjectTemplate {
  id             String   @id @default(cuid()) @db.VarChar(255)
  name           String   @db.VarChar(200)
  description    String?  @db.Text
  structure      Json?    // Template structure (lists, default statuses, etc.)
  organizationId String   @db.VarChar(255)
  createdById    String   @db.VarChar(255)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  projects     Project[]
  createdBy    User?        @relation("UserCreatedProjectTemplates", fields: [createdById], references: [id])
  
  @@map("project_templates")
  @@index([organizationId])
}

model ProjectMember {
  id                String   @id @default(cuid()) @db.VarChar(255)
  projectId         String   @db.VarChar(255)
  organizationMemberId String @db.VarChar(255)
  roleId            String   @db.VarChar(255)
  isFavorite        Boolean  @default(false)
  notificationSettings Json?  @default("{}")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  project            Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  organizationMember OrganizationMember @relation(fields: [organizationMemberId], references: [id], onDelete: Cascade)
  role               Role               @relation(fields: [roleId], references: [id])
  assignedTasks      TaskAssignee[]
  timeEntries        TimeEntry[]
  
  @@unique([projectId, organizationMemberId])
  @@map("project_members")
  @@index([projectId])
  @@index([organizationMemberId])
  @@index([roleId])
  @@index([isFavorite])
}

model List {
  id        String   @id @default(cuid()) @db.VarChar(255)
  name      String   @db.VarChar(200)
  position  Int      @default(0)
  projectId String   @db.VarChar(255)
  isArchived Boolean @default(false)
  settings  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   Task[]
  dependencies ListDependency[] @relation("SourceList")
  dependents   ListDependency[] @relation("TargetList")
  
  @@map("lists")
  @@index([projectId, position])
  @@index([projectId, isArchived])
}

model Task {
  id              String   @id @default(cuid()) @db.VarChar(255)
  title           String   @db.VarChar(500)
  description     String?  @db.Text
  statusId        String?  @db.VarChar(255)
  priority        String   @default("MEDIUM") @db.VarChar(20)
  dueDate         DateTime?
  completedAt     DateTime?
  estimatedHours  Decimal? @db.Decimal(5, 2)
  actualHours     Decimal? @db.Decimal(10, 2) @default(0)
  position        Int      @default(0)
  projectId       String   @db.VarChar(255)
  listId          String?  @db.VarChar(255)
  parentId        String?  @db.VarChar(255)
  milestoneId     String?  @db.VarChar(255)
  isArchived      Boolean  @default(false)
  tags            String[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdById     String   @db.VarChar(255)
  updatedById     String   @db.VarChar(255)
  
  // Relations
  project     Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  list        List?              @relation(fields: [listId], references: [id], onDelete: SetNull)
  statusDef   TaskStatusDefinition? @relation(fields: [statusId], references: [id], onDelete: SetNull)
  status      TaskStatusEnum      @default(TODO) @map("status_enum")
  parent      Task?     @relation("SubTasks", fields: [parentId], references: [id], onDelete: Cascade)
  children    Task[]    @relation("SubTasks")
  createdBy   User      @relation("TaskCreator", fields: [createdById], references: [id])
  updatedBy   User      @relation("TaskUpdater", fields: [updatedById], references: [id])
  assignees   TaskAssignee[]
  comments    Comment[]
  dependencies TaskDependency[] @relation("SourceTask")
  dependents   TaskDependency[] @relation("TargetTask")
  activityLogs ActivityLog[]
  notifications Notification[]
  timeEntries  TimeEntry[]
  files        FileLink[]
  attachedFiles File[]
  milestone    Milestone? @relation(fields: [milestoneId], references: [id], onDelete: SetNull)
  
  @@map("tasks")
  @@index([projectId])
  @@index([listId])
  @@index([parentId])
  @@index([milestoneId])
  @@index([dueDate])
  @@index([priority])
  @@index([createdById])
  @@index([statusId])
  @@index([isArchived])
  @@index([tags])
}

model TaskAssignee {
  id              String   @id @default(cuid()) @db.VarChar(255)
  taskId          String   @db.VarChar(255)
  projectMemberId String   @db.VarChar(255)
  assignedAt      DateTime @default(now())
  assignedById    String   @db.VarChar(255)
  
  // Relations
  task         Task          @relation(fields: [taskId], references: [id], onDelete: Cascade)
  projectMember ProjectMember @relation(fields: [projectMemberId], references: [id], onDelete: Cascade)
  assignedBy   User          @relation(fields: [assignedById], references: [id])
  
  @@unique([taskId, projectMemberId])
  @@map("task_assignees")
  @@index([taskId])
  @@index([projectMemberId])
}

model Comment {
  id          String   @id @default(cuid()) @db.VarChar(255)
  content     String   @db.Text
  taskId      String?  @db.VarChar(255)
  projectId   String?  @db.VarChar(255)
  parentId    String?  @db.VarChar(255)
  createdById String   @db.VarChar(255)
  isEdited    Boolean  @default(false)
  editedAt    DateTime?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  task      Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parent    Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")
  createdBy User     @relation(fields: [createdById], references: [id], onDelete: Cascade)
  files     FileLink[]
  mentions  Mention[]
  
  @@map("comments")
  @@index([taskId])
  @@index([projectId])
  @@index([parentId])
  @@index([createdById])
  @@index([createdAt])
}

model Mention {
  id            String   @id @default(cuid()) @db.VarChar(255)
  commentId     String   @db.VarChar(255)
  userId        String   @db.VarChar(255)
  mentionedById String   @db.VarChar(255)
  isRead        Boolean  @default(false)
  readAt        DateTime?
  createdAt     DateTime @default(now())
  
  // Relations
  comment       Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user          User    @relation("UserMentions", fields: [userId], references: [id], onDelete: Cascade)
  mentionedBy   User    @relation("UserMentionedIn", fields: [mentionedById], references: [id], onDelete: Cascade)
  notification  Notification?
  
  @@unique([commentId, userId])
  @@map("mentions")
  @@index([commentId])
  @@index([userId])
  @@index([mentionedById])
  @@index([isRead])
}

model TaskDependency {
  id        String         @id @default(cuid()) @db.VarChar(255)
  sourceId  String         @db.VarChar(255)
  targetId  String         @db.VarChar(255)
  type      DependencyType @default(FINISH_TO_START)
  createdAt DateTime       @default(now())
  
  // Relations
  source Task @relation("SourceTask", fields: [sourceId], references: [id], onDelete: Cascade)
  target Task @relation("TargetTask", fields: [targetId], references: [id], onDelete: Cascade)
  
  @@unique([sourceId, targetId])
  @@map("task_dependencies")
  @@index([sourceId])
  @@index([targetId])
}

model ListDependency {
  id         String         @id @default(cuid()) @db.VarChar(255)
  sourceId   String         @db.VarChar(255)
  targetId   String         @db.VarChar(255)
  type       DependencyType @default(FINISH_TO_START)
  createdAt  DateTime       @default(now())
  
  // Relations
  source List @relation("SourceList", fields: [sourceId], references: [id], onDelete: Cascade)
  target List @relation("TargetList", fields: [targetId], references: [id], onDelete: Cascade)
  
  @@unique([sourceId, targetId])
  @@map("list_dependencies")
  @@index([sourceId])
  @@index([targetId])
}

model TaskStatusDefinition {
  id             String   @id @default(cuid()) @db.VarChar(255)
  name           String   @db.VarChar(100)
  description    String?  @db.Text
  color          String   @default("#64748B") @db.VarChar(7)
  icon           String?  @db.VarChar(50)
  position       Int      @default(0)
  isDefault      Boolean  @default(false)
  isCompleted    Boolean  @default(false)
  organizationId String   @db.VarChar(255)
  createdById    String   @db.VarChar(255)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tasks        Task[]
  createdBy    User?        @relation("UserCreatedTaskStatuses", fields: [createdById], references: [id])
  
  @@unique([organizationId, name])
  @@map("task_status_definitions")
  @@index([organizationId])
  @@index([position])
  @@index([isDefault])
}

model Milestone {
  id          String   @id @default(cuid()) @db.VarChar(255)
  name        String   @db.VarChar(200)
  description String?  @db.Text
  dueDate     DateTime
  completedAt DateTime?
  projectId   String   @db.VarChar(255)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   Task[]
  
  @@map("milestones")
  @@index([projectId])
  @@index([dueDate])
}

model ActivityLog {
  id         String   @id @default(cuid()) @db.VarChar(255)
  action     String   @db.VarChar(100)
  entityType String   @db.VarChar(50)
  entityId   String   @db.VarChar(255)
  description String?  @db.Text
  oldData    Json?
  newData    Json?
  userId     String   @db.VarChar(255)
  projectId  String?  @db.VarChar(255)
  taskId     String?  @db.VarChar(255)
  ipAddress  String?  @db.VarChar(45)
  userAgent  String?  @db.Text
  createdAt  DateTime @default(now())
  
  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task    Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  @@map("activity_logs")
  @@index([userId])
  @@index([projectId])
  @@index([taskId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

model Notification {
  id        String   @id @default(cuid()) @db.VarChar(255)
  title     String   @db.VarChar(200)
  message   String   @db.Text
  type      String   @db.VarChar(50)
  isRead    Boolean  @default(false)
  userId    String   @db.VarChar(255)
  projectId String?  @db.VarChar(255)
  taskId    String?  @db.VarChar(255)
  mentionId String?  @unique @db.VarChar(255)
  data      Json?
  createdAt DateTime @default(now())
  readAt    DateTime?
  
  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task    Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  mention Mention? @relation(fields: [mentionId], references: [id], onDelete: Cascade)
  
  @@map("notifications")
  @@index([userId, isRead])
  @@index([projectId])
  @@index([taskId])
  @@index([createdAt])
  @@index([type])
}

model TimeEntry {
  id              String   @id @default(cuid()) @db.VarChar(255)
  description     String?  @db.Text
  startTime       DateTime
  endTime         DateTime?
  duration        Int?     @default(0) // in minutes
  billable        Boolean  @default(false)
  billingRate     Decimal? @db.Decimal(10, 2)
  taskId          String   @db.VarChar(255)
  projectMemberId String   @db.VarChar(255)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  task          Task          @relation(fields: [taskId], references: [id], onDelete: Cascade)
  projectMember ProjectMember @relation(fields: [projectMemberId], references: [id], onDelete: Cascade)
  
  @@map("time_entries")
  @@index([taskId])
  @@index([projectMemberId])
  @@index([startTime])
  @@index([billable])
}

model File {
  id            String         @id @default(cuid()) @db.VarChar(255)
  name          String         @db.VarChar(500)
  mimeType      String         @db.VarChar(100)
  size          Int            // in bytes
  url           String         @db.VarChar(1000)
  storageProvider StorageProvider @default(LOCAL)
  storagePath   String?        @db.VarChar(1000)
  isPublic      Boolean        @default(false)
  projectId     String?        @db.VarChar(255)
  taskId        String?        @db.VarChar(255)
  createdById   String         @db.VarChar(255)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  // Relations
  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task      Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  createdBy User     @relation("UserCreatedFiles", fields: [createdById], references: [id])
  versions  FileVersion[]
  links     FileLink[] @relation("FileLinks")
  
  @@map("files")
  @@index([projectId])
  @@index([taskId])
  @@index([createdById])
  @@index([createdAt])
}

model FileVersion {
  id          String   @id @default(cuid()) @db.VarChar(255)
  fileId      String   @db.VarChar(255)
  version     Int
  name        String   @db.VarChar(500)
  mimeType    String   @db.VarChar(100)
  size        Int
  url         String   @db.VarChar(1000)
  changeNote  String?  @db.VarChar(500)
  createdById String   @db.VarChar(255)
  createdAt   DateTime @default(now())
  
  // Relations
  file      File @relation(fields: [fileId], references: [id], onDelete: Cascade)
  createdBy User @relation("UserCreatedFileVersions", fields: [createdById], references: [id])
  
  @@unique([fileId, version])
  @@map("file_versions")
  @@index([fileId])
  @@index([createdById])
}

model FileLink {
  id        String   @id @default(cuid()) @db.VarChar(255)
  fileId    String   @db.VarChar(255)
  taskId    String?  @db.VarChar(255)
  commentId String?  @db.VarChar(255)
  projectId String?  @db.VarChar(255)
  createdAt DateTime @default(now())
  
  // Relations
  file    File    @relation("FileLinks", fields: [fileId], references: [id], onDelete: Cascade)
  task    Task?   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  comment Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@map("file_links")
  @@index([fileId])
  @@index([taskId])
  @@index([commentId])
  @@index([projectId])
}